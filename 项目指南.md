# ESP32-C3 REST API服务器开发指南

## 项目架构概述
本项目基于ESP-IDF框架实现了一个集成SmartConfig配网和RESTful API的服务器系统，主要包含以下组件：
- **配网模块**：通过SmartConfig实现WiFi快速配置
- **Web服务器**：基于ESP-IDF HTTP Server组件
- **文件系统**：支持SPIFFS/SD卡/半主机三种存储方式
- **API接口**：提供系统信息、温度数据和灯光控制功能
- **Web界面**：通过Vue构建的管理前端

主要代码文件结构：
```
esp32c3/
├── main/
│   ├── main.c              # 应用入口点
│   └── Kconfig.projbuild   # 项目配置选项
└── src/
    ├── esp_rest.c          # 主程序实现
    ├── rest_server.c       # REST API实现
    ├── event_handler.c     # 事件处理
    └── integration_guide.md # 集成文档
```

## 开发环境搭建
### 1. 必要工具
- ESP-IDF v5.4或更高版本
- Node.js (用于前端构建)
- Python (用于烧录工具)
- VS Code (推荐IDE)

### 2. 项目配置
```bash
# 克隆项目后初始化
idf.py set-target esp32c3
idf.py menuconfig
```
在配置菜单中设置：
- `Web server mount point`：/spiffs
- `mDNS Host Name`：esp32
- `Web partition label`：web

## 添加新功能示例：湿度传感器API
以下是添加湿度传感器数据接口的详细步骤：

### 步骤1：实现后端API处理函数
修改<mcfile name="rest_server.c" path="e:\ESP-IDF\ESP-Projects\esp32c3\src\rest_server.c"></mcfile>，添加湿度数据处理函数：

```c
/* 获取湿度数据的处理程序 */
static esp_err_t humidity_data_get_handler(httpd_req_t *req)
{
    httpd_resp_set_type(req, "application/json");  // 设置响应类型为JSON
    cJSON *root = cJSON_CreateObject();
    // 实际项目中应替换为传感器读取代码
    cJSON_AddNumberToObject(root, "raw", (esp_random() % 50) + 30);  // 生成30-80%的随机湿度数据
    const char *humidity_info = cJSON_Print(root);
    httpd_resp_sendstr(req, humidity_info);  // 发送湿度数据
    free((void *)humidity_info);
    cJSON_Delete(root);
    return ESP_OK;
}
```

### 步骤2：注册API端点
在同一文件的`start_rest_server`函数中注册新端点：

```c
/* URI handler for fetching humidity data */
httpd_uri_t humidity_data_get_uri = {
    .uri = "/api/v1/humidity/raw",
    .method = HTTP_GET,
    .handler = humidity_data_get_handler,
    .user_ctx = rest_context
};
httpd_register_uri_handler(server, &humidity_data_get_uri);  // 注册湿度数据获取处理程序
```

### 步骤3：前端界面修改
1. 在Vue项目中创建湿度显示组件`components/Humidity.vue`：
```vue
<template>
  <div class="sensor-card">
    <h3>湿度监测</h3>
    <div class="value">{{ humidity }}%</div>
    <div class="update-time">最后更新: {{ lastUpdate }}</div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      humidity: 0,
      lastUpdate: ''
    }
  },
  mounted() {
    this.fetchHumidity();
    setInterval(() => this.fetchHumidity(), 5000);
  },
  methods: {
    async fetchHumidity() {
      try {
        const response = await fetch('/api/v1/humidity/raw');
        const data = await response.json();
        this.humidity = data.raw;
        this.lastUpdate = new Date().toLocaleTimeString();
      } catch (error) {
        console.error('Failed to fetch humidity:', error);
      }
    }
  }
}
</script>
```

2. 在主页面中引入该组件：
```vue
<template>
  <div class="dashboard">
    <Temperature />
    <Humidity />
    <LightControl />
  </div>
</template>

<script>
import Temperature from './components/Temperature.vue'
import Humidity from './components/Humidity.vue'
import LightControl from './components/LightControl.vue'

export default {
  components: { Temperature, Humidity, LightControl }
}
</script>
```

### 步骤4：构建和部署前端
```bash
# 进入前端目录
cd web-demo

# 安装依赖
npm install

# 构建生产版本
npm run build

# 上传到ESP32-C3
python $IDF_PATH/components/esptool_py/esptool/esptool.py --chip esp32c3 \
  --port COM3 --baud 921600 --before default_reset --after hard_reset write_flash \
  0x110000 dist/*
```

### 步骤5：验证新功能
1. 重新编译并烧录固件：
```bash
idf.py build flash monitor
```

2. 配网成功后，通过浏览器访问设备IP或mDNS域名(esp32.local)

3. 新添加的湿度监测组件应显示在Web界面上，并每5秒更新一次数据

## 常见问题排查
1. **API端点404错误**：检查URI注册是否正确，确保`httpd_register_uri_handler`被正确调用

2. **文件系统挂载失败**：
   - 检查分区表配置是否正确
   - 确认SPIFFS分区已格式化
   - 使用`esp_spiffs_info`验证分区大小

3. **前端更新不生效**：
   - 确认构建路径正确
   - 检查烧录地址是否与分区表匹配
   - 清除浏览器缓存或使用无痕模式

## 扩展建议
1. **数据持久化**：使用NVS存储历史数据
2. **认证机制**：添加JWT或Basic Auth保护API
3. **WebSocket**：实现实时数据推送
4. **OTA升级**：集成HTTP OTA功能实现远程升级

通过以上步骤，你可以轻松扩展ESP32-C3的Web功能，添加各种传感器数据采集或设备控制接口。项目遵循模块化设计，新功能的添加不会影响现有系统稳定性。